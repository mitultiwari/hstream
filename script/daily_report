#!/usr/bin/env zsh

echo To: akkartik@gmail.com, mitultiwari@gmail.com, tk@tristankromer.com
echo Subject: AARRR HackerStream metrics for yesterday
echo

export PATH=.:/app/hackerstream/log/yam:/app/local/0bin:/app/local/share/scripts:/app/local/share/scripts/Startup:/app/local/share/scripts/Data:$PATH:/usr/sbin
export RUBYLIB=/app/hackerstream/log/yam:$RUBYLIB
cd /app/hackerstream/log

wgrep() {
  grep -w $*
}

log_file() {
  echo development.log.$(date +"%Y%m%d" -d '-'$1' day')
}

grep STAT `log_file 1` |grep "/\.js" |column 2 |sort |uniq > y.non_crawler
echo Acquisition: $(grep STAT `log_file 1` |wgrep -f y.non_crawler |grep -v "/\.js" |column 2 |sort |uniq |wc -l) sessions
echo " " $(grep STAT `log_file 1` |wgrep -f y.non_crawler |grep -v "/\.js" |grep google |column 2 |sort |uniq |wc -l) from google
echo "   " $(grep STAT `log_file 1` |wgrep -f y.non_crawler |grep -v "/\.js" |grep ad=g |column 2 |sort |uniq |wc -l) from adwords

grep "STAT.*google" `log_file 1` |column 4 > y.google
grep "STAT.*google" `log_file 1` |column 5 >> y.google

div() {
  printf "%.3f" $(($1.0/$2))
}

grep Started `log_file 1` |wgrep -f y.non_crawler |grep -v "/\.js\|/?item\|/? " > y.clicks
Nr=`wc -l < y.clicks`
Dr=`cat y.clicks |column 5 |sort |uniq |wc -l`
echo "Activation: $Nr clicks in $Dr sessions (`div $Nr $Dr` per session)"
Nr=`cat y.clicks |column 5 |wgrep -f y.google |wc -l`
Dr=`cat y.clicks |column 5 |wgrep -f y.google |sort |uniq |wc -l`
echo "  $Nr clicks in $Dr sessions from google (`div $Nr $Dr` per session)"
Nr=`cat y.clicks |column 5 |wgrep -vf y.google |wc -l`
Dr=`cat y.clicks |column 5 |wgrep -vf y.google |sort |uniq |wc -l`
echo "  $Nr clicks in $Dr sessions from elsewhere (`div $Nr $Dr` per session)"

grep "Started.*/more" `log_file 1` > y.refreshes
Nr=`wc -l < y.refreshes`
Dr=`cat y.refreshes |column 5 |sort |uniq |wc -l`
echo "Activation: $Nr refreshes in $Dr sessions (`div $Nr $Dr` per session)"
Nr=`cat y.refreshes |column 5 |wgrep -f y.google |wc -l`
Dr=`cat y.refreshes |column 5 |wgrep -f y.google |sort |uniq |wc -l`
echo "  $Nr refreshes in $Dr sessions from google (`div $Nr $Dr` per session)"

grep "Started.*follow" `log_file 1` > y.follows
Nr=`wc -l < y.follows`
Dr=`cat y.follows |column 5 |sort |uniq |wc -l`
echo "Activation: $Nr follows in $Dr sessions (`div $Nr $Dr` per session)"
Nr=`cat y.follows |column 5 |wgrep -f y.google |wc -l`
Dr=`cat y.follows |column 5 |wgrep -f y.google |sort |uniq |wc -l`
echo "  $Nr follows in $Dr sessions from google (`div $Nr $Dr` per session)"
