#!/usr/bin/env zsh

echo To: akkartik@gmail.com, mitultiwari@gmail.com
echo Subject: AARRR HackerStream metrics for yesterday
echo

export PATH=.:/app/hackerstream/log/yam:/app/local/0bin:/app/local/share/scripts:/app/local/share/scripts/Startup:/app/local/share/scripts/Data:$PATH:/usr/sbin
export RUBYLIB=/app/hackerstream/log/yam:$RUBYLIB
cd /app/hackerstream/log

wgrep() {
  grep -w $*
}

compute_date() {
  date +${2:-"%Y%m%d"} -d '-'$1' day'
}

percent() {
  printf "%.1f%%" $(($1.0/$2*100))
}

cp ../db/development.sqlite3 .

echo "Date: Sessions -> More button -> Follow button -> Login"

stats() {
  date=`compute_date $1`

  if [ $date -gt "20110524" ] # that's when we added session cookie and username to STAT lines
  then
    grep "STAT" development.log.$date |grep "/\.js" |column 4 |sort |uniq |grep -v "[a-z]" > y.realips.$date
    grep "STAT" development.log.$date |grep "/\.js" |column 5 |sort |uniq |grep -v "[a-z]" >> y.realips.$date
  else
    grep "STAT" development.log.$date |grep "/\.js" |column 2 |sort |uniq |grep -v "[a-z]" > y.realips.$date
    grep "STAT" development.log.$date |grep "/\.js" |column 3 |sort |uniq |grep -v "[a-z]" >> y.realips.$date
  fi
  acq=`grep STAT development.log.$date |wgrep -f y.realips.$date |grep -v "/\.js" |column 5 |sort |uniq |wc -l`

  grep "Started" development.log.$date |wgrep -f y.realips.$date |grep -v "/\.js\|/?item\|/? " > y.clicks.$date
  clicks=`cat y.clicks.$date |column 5 |sort |uniq |wc -l`

  grep "Started.*/more" development.log.$date > y.more.$date
  more=`cat y.more.$date |column 5 |sort |uniq |wc -l`

  grep "Started.*/follow\>" development.log.$date > y.follow.$date
  follow=`cat y.follow.$date |column 5 |sort |uniq |wc -l`

  if [ $date -gt "20110525" ]
  then
    login=`grep STAT development.log.$date |column 3 |sort |uniq |grep -v "^nil$" |wc -l`
  else
    login=0
  fi

  echo "select created_at from logins;" |sqlite3 development.sqlite3 > y.logins.$date
  newlogins=`grep $(compute_date $1 "%Y-%m-%d") y.logins.$date |wc -l`
  logins=`wc -l < y.logins.$date`

  echo "$date: $acq -> $more (`percent $more $acq`) -> $follow (`percent $follow $acq`) -> $login (`percent $login $acq`)"
  grep $date milestones
}

for offset in `seq 1 14`
do
  stats $offset
done
