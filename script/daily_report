#!/usr/bin/env zsh

echo To: akkartik@gmail.com, mitultiwari@gmail.com
echo Subject: AARRR HackerStream metrics for yesterday
echo

export PATH=.:/app/hackerstream/log/yam:/app/local/0bin:/app/local/share/scripts:/app/local/share/scripts/Startup:/app/local/share/scripts/Data:$PATH:/usr/sbin
export RUBYLIB=/app/hackerstream/log/yam:$RUBYLIB
cd /app/hackerstream/log

wgrep() {
  grep -w $*
}

yday() {
  date +"%Y%m%d" -d '-1 day'
}

grep STAT development.log.`yday` |grep "/\.js" |column 4 |sort |uniq |grep -v "[a-z]" > y.non_crawler
grep STAT development.log.`yday` |grep "/\.js" |column 5 |sort |uniq |grep -v "[a-z]" >> y.non_crawler
Acq=$(grep STAT development.log.`yday` |wgrep -f y.non_crawler |grep -v "/\.js" |column 5 |sort |uniq |wc -l)
echo "Acquisition: $Acq IPs"
Goog=$(grep STAT development.log.`yday` |wgrep -f y.non_crawler |grep -v "/\.js" |grep google |column 5 |sort |uniq |wc -l)
echo "  $Goog from google"
X=$(grep STAT development.log.`yday` |wgrep -f y.non_crawler |grep -v "/\.js" |grep ad=g |column 5 |sort |uniq |wc -l)
echo "    $X from adwords"
X=$(grep STAT development.log.`yday` |wgrep -f y.non_crawler |column 2 |sort |uniq |wc -l)
echo "Acquisition: $X unique session cookies"

grep "STAT.*google" development.log.`yday` |column 4 > y.google
grep "STAT.*google" development.log.`yday` |column 5 >> y.google

percent() {
  printf "%.1f%%" $(($1.0/$2*100))
}

grep Started development.log.`yday` |wgrep -f y.non_crawler |grep -v "/\.js\|/?item\|/? " > y.clicks
X=`cat y.clicks |column 5 |sort |uniq |wc -l`
echo "Activation: $X sessions with clicks (`percent $X $Acq`)"
X=`cat y.clicks |column 5 |wgrep -f y.google |sort |uniq |wc -l`
echo "  $X sessions from google (`percent $X $Goog`)"
X=$(grep STAT development.log.`yday` |column 3 |sort |uniq |grep -v "^nil$" |wc -l)
echo "  $X logged-in users"

grep "Started.*/more" development.log.`yday` > y.refreshes
X=`cat y.refreshes |column 5 |sort |uniq |wc -l`
echo "Activation: $X sessions hit the more button (`percent $X $Acq`)"
X=`cat y.refreshes |column 5 |wgrep -f y.google |sort |uniq |wc -l`
echo "  $X sessions from google (`percent $X $Goog`)"

grep "Started.*follow" development.log.`yday` > y.follows
X=`cat y.follows |column 5 |sort |uniq |wc -l`
echo "Activation: $X sessions followed somebody (`percent $X $Acq`)"
X=`cat y.follows |column 5 |wgrep -f y.google |sort |uniq |wc -l`
echo "  $X sessions from google (`percent $X $Goog`)"

echo "select created_at from logins;" |sqlite3 ../db/development.sqlite3 > y.logins
X=`grep $(date +"%Y-%m-%d" -d '-1 day') y.logins |wc -l`
Y=`wc -l < y.logins`
echo "Activation: $X new logins created ($Y total)"
